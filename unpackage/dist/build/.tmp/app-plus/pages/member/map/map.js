(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/member/map/map"],{3853:function(e,t,a){"use strict";a.r(t);var o=a("3fbf"),n=a("a823");for(var i in n)"default"!==i&&function(e){a.d(t,e,function(){return n[e]})}(i);a("3ce6");var s=a("2877"),r=Object(s["a"])(n["default"],o["a"],o["b"],!1,null,null,null);t["default"]=r.exports},"3ce6":function(e,t,a){"use strict";var o=a("831a"),n=a.n(o);n.a},"3fbf":function(e,t,a){"use strict";var o=function(){var e=this,t=e.$createElement;e._self._c},n=[];a.d(t,"a",function(){return o}),a.d(t,"b",function(){return n})},"831a":function(e,t,a){},a823:function(e,t,a){"use strict";a.r(t);var o=a("cc0a"),n=a.n(o);for(var i in o)"default"!==i&&function(e){a.d(t,e,function(){return o[e]})}(i);t["default"]=n.a},cc0a:function(e,t,a){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o,n=getApp().globalData.weburl,i=(getApp().globalData.shop_type,getApp().globalData.mapkey,wx.getStorageSync("userInfo")?wx.getStorageSync("userInfo"):""),s=14,r=getApp().globalData.mapInterval,c=a("be18"),l=a("ef60"),u=wx.getStorageSync("m_id")?wx.getStorageSync("m_id"):0,d=wx.getStorageSync("username")?wx.getStorageSync("username"):"",m=wx.getStorageSync("token")?wx.getStorageSync("token"):"1",p=0,g=0,f=0,h="myMap",v=[["compressed"],["original"],["compressed","original"]],w={data:function(){return{userInfo:i,openSetting:0,m_id:u,username:d,token:m,hasUserInfo:!1,longitude:"",latitude:"",interval:r||2e4,scale:s,markers:[],showTopTip:!0,warningText:"顶部提示",showUpload:!0,showConfirm:!1,showComment:!1,mapHeight:0,infoAddress:"",commentCount:0,praiseCount:0,commentList:[],selectAddress:"",centerLongitude:"",centerLatitude:"",uploadImagePath:"",currentMarkerId:0,praiseSrc:"../../../images/bottom-unpraise.png",warningIconUrl:"",infoMessage:"",isUp:!1,controls:[],centerAddressBean:null,callbackAddressInfo:null,callbackLocation:null,currentProvince:"",currentCity:"",currentDistrict:"",showHomeActionIcon:!0,homeActionLeftDistance:"0rpx",currentTipInfo:"",showCommentInput:!1,commentMessage:"",shareLongitude:"",shareLatitude:"",showShare:!1,userAvatar:i.avatarUrl,userNickname:i.nickName,uploadTime:"",hasMarkers:!0,activity_lat:"",activity_lng:"",activity_title:"",activity_address:"",activity_id:"",activity_omid:"",member_loc:"",loc_name:"",markersMy:"",polyline:""}},components:{},props:{},onLoad:function(t){var a=this,o=t.lat,n=t.lng,i=t.title?t.title:"",s=t.activity_id?t.activity_id:0,r=t.activity_address?t.activity_address:"",c=t.activity_omid?t.activity_omid:0;this.setData({activity_lat:o,activity_lng:n,activity_title:i,activity_address:r,activity_id:s,activity_omid:c}),console.log(e("map onlod activity_lat:",o," activity_lng:",n," activity_title:",i," activity_id:",s," at pages\\member\\map\\map.vue:194")),wx.getSetting({success:function(t){var a=t.authSetting,o=Object.keys(a).length;console.log(e("authMap info 长度:"+o,a," at pages\\member\\map\\map.vue:199")),a.hasOwnProperty("scope.userLocation")&&(t.authSetting["scope.userLocation"]||wx.showModal({title:"用户未授权",content:"请授权地理位置权限",showCancel:!1,success:function(t){t.confirm&&(console.log(e("用户点击确定授权地理位置权限"," at pages\\member\\map\\map.vue:209")),wx.openSetting({success:function(t){console.log(e("openSetting success",t.authSetting," at pages\\member\\map\\map.vue:212"))}}))}}))}}),a.checkUpdate(),a.userInfo?this.setData({hasUserInfo:!0}):getApp().globalData.getUserInfo(function(e){a.setData({userInfo:e,hasUserInfo:!0})}),a.requestLocation(),a.scopeSetting()},onShow:function(){console.log(e("onShow---------------------\x3e"," at pages\\member\\map\\map.vue:259"));var t=this;t.changeMapHeight(),console.log(e(t.callbackAddressInfo," at pages\\member\\map\\map.vue:264")),null==t.callbackAddressInfo?(t.getCenterLocation(),t.showUpload):(t.setData({selectAddress:t.callbackAddressInfo.title,callbackLocation:t.callbackAddressInfo.location}),t.setData({callbackAddressInfo:null}))},onHide:function(){},onShareAppMessage:function(e){},methods:{getSetting:function(t){t.detail.authSetting["scope.userLocation"]?this.setData({openSetting:1}):(wx.authorize({scope:"scope.userLocation",success:function(){console.log(e("位置授权成功"+res.errMsg," at pages\\member\\map\\map.vue:300")),wx.setStorageSync("userLocation","1")}}),this.setData({openSetting:1}))},showNewMarkerClick:function(){wx.showModal({title:"提示",content:"你点击了顶部提示框",showCancel:!1})},setHomeActionLeftDistance:function(){var t=this;t.showUpload&&wx.getSystemInfo({success:function(t){g=t.windowHeight,f=t.windowWidth;var a=wx.createSelectorQuery();a.select("#home-action-wrapper").boundingClientRect(),a.exec(function(t){console.log(e(t," at pages\\member\\map\\map.vue:343"))})}})},changeMapHeight:function(){var t=this;wx.getSystemInfo({success:function(a){console.log(e(a," at pages\\member\\map\\map.vue:358")),g=a.windowHeight,f=a.windowWidth;var o=wx.createSelectorQuery();o=wx.createSelectorQuery();o.select("#bottom-layout").boundingClientRect(),o.exec(function(a){console.log(e(a," at pages\\member\\map\\map.vue:366")),p=a[0].height,t.setMapHeight()})}})},setMapHeight:function(e){var t=this;t.setData({mapHeight:g-p+"px"});var a=40,o=48;t.setData({controls:[{id:1,iconPath:"../../../images/center-location.png",position:{left:(f-a)/2,top:(g-p)/2-3*o/4,width:a,height:o},clickable:!0}]})},scopeSetting:function(){var t=this;console.log(e("scopeSetting"," at pages\\member\\map\\map.vue:397")),t.initMap()},initMap:function(){var t=this;o=new l({key:c.tencentAk}),console.log(e("初始化地图"," at pages\\member\\map\\map.vue:409")),t.getCenterLocation(),t.getMemberLocation()},requestLocation:function(){var t=this,a=t.activity_id;wx.getLocation({type:"gcj02",success:function(a){t.setData({latitude:a.latitude?a.latitude:t.latitude,longitude:a.longitude?a.longitude:t.longitude}),console.log(e("requestLocation:",a," at pages\\member\\map\\map.vue:429")),t.moveTolocation(),t.reportLocation(),t.queryMarkerInfo()}}),a>0&&setTimeout(function(){t.requestLocation()},t.interval)},reportLocation:function(){var t=this;wx.request({url:n+"/api/client/update_member_loc",method:"POST",data:{username:t.username?t.username:wx.getStorageSync("username"),access_token:t.token?t.token:wx.getStorageSync("token"),m_id:t.m_id?t.m_id:0,latitude:t.latitude,longitude:t.longitude,shop_type:t.shop_type},header:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},success:function(a){console.log(e("reportLocation:",a," at pages\\member\\map\\map.vue:461"));var o=a.data.result;o&&(t.setData({interval:o["interval"]}),getApp().globalData.mapInterval=o["interval"])}})},getMemberLocation:function(){var t=this,a=t.activity_id,o=t.shop_type;wx.request({url:n+"/api/client/get_member_loc",method:"POST",data:{username:t.username?t.username:wx.getStorageSync("username"),access_token:t.token?t.token:wx.getStorageSync("token"),m_id:t.m_id?t.m_id:0,activity_id:a,shop_type:o},header:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},success:function(a){var o=a.data.result?a.data.result:"",n=[];if(o){for(var i=0;i<o.length;i++){var s={id:i+3,name:o[i]["wx_nickname"],latitude:parseFloat(o[i]["latitude"]),longitude:parseFloat(o[i]["longitude"]),width:25,height:25,iconPath:o[i]["wx_headimg"]?o[i]["wx_headimg"]:"../../../images/ai.png",callout:{content:o[i]["wx_nickname"],color:"#2c8df6",fontSize:12,borderRadius:10,bgColor:"#fff",display:"ALWAYS",boxShadow:"5px 5px 10px #aaa"}};n.push(s)}t.setData({member_loc:n,hasMarkers:!0}),t.queryMarkerInfo(),console.log(e("map getMemberLocation success:",a,"member_loc:",t.member_loc," at pages\\member\\map\\map.vue:526"))}}}),a>0&&setTimeout(function(){t.getMemberLocation()},t.interval)},bindMakertap:function(t){var a=this;for(var o in a.setData({currentMarkerId:t.markerId}),console.log(e("currentMarkerId:",a.currentMarkerId," at pages\\member\\map\\map.vue:547")),a.markers){var n=a.markers[o];t.markerId==n.id&&a.setData({loc_name:1==t.markerId?a.activity_address:n.name})}wx.showModal({title:"这里是",content:a.loc_name?a.loc_name:"位置",showCancel:!1})},uploadInfoClick:function(){var e=this;e.adjustViewStatus(!1,!0,!1),e.updateCenterLocation(e.latitude,e.longitude)},updateCenterLocation:function(e,t){var a=this;a.setData({centerLatitude:e,centerLongitude:t}),a.regeocodingAddress()},selfLocationClick:function(){var t=this;t.setData({scale:s}),wx.getLocation({type:"gcj02",success:function(a){t.setData({latitude:a.latitude,longitude:a.longitude}),console.log(e("selfLocationClick:",a," at pages\\member\\map\\map.vue:608"))}})},moveTolocation:function(){var e=wx.createMapContext(h);e.moveToLocation()},cancelClick:function(){var e=this;e.resetPhoto(),e.adjustViewStatus(!0,!1,!1)},confirmClick:function(t){var a=this;console.log(e(t," at pages\\member\\map\\map.vue:631"));var o=t.detail.value.message.trim();a.centerLatitude&&a.centerLongitude?o||a.showModal("请说点什么吧~"):a.showModal("请选择上传地点~")},controlTap:function(){},bindMapTap:function(){this.adjustViewStatus(!0,!1,!1)},adjustViewStatus:function(e,t,a){var o=this;o.setData({showUpload:e,showConfirm:t,showComment:a}),o.changeMapHeight()},previewImage:function(){var e=this;wx.previewImage({urls:[e.warningIconUrl]})},takePhoto:function(){var e=this;wx.chooseImage({sizeType:v[1],count:1,success:function(t){e.setData({uploadImagePath:t.tempFilePaths[0]}),e.adjustViewStatus(!1,!0,!1)}})},deleteSelectImage:function(){this.resetPhoto()},resetPhoto:function(){var e=this;e.setData({uploadImagePath:""})},previewSelectImage:function(){var e=this;wx.previewImage({urls:[e.uploadImagePath]})},regionChange:function(e){var t=this;"end"==e.type&&t.getCenterLocation()},getCenterLocation:function(){var t=this,a=wx.createMapContext(h);a.getCenterLocation({success:function(a){console.log(e("getCenterLocation-----------------------\x3e"," at pages\\member\\map\\map.vue:739")),console.log(e(a," at pages\\member\\map\\map.vue:740")),t.updateCenterLocation(a.latitude,a.longitude)}})},regeocodingAddress:function(){var t=this;t.showConfirm&&o.reverseGeocoder({location:{latitude:t.centerLatitude,longitude:t.centerLongitude},success:function(a){console.log(e(a," at pages\\member\\map\\map.vue:763")),t.setData({centerAddressBean:a.result,selectAddress:a.result.formatted_addresses.recommend,currentProvince:a.result.address_component.province,currentCity:a.result.address_component.city,currentDistrict:a.result.address_component.district})},fail:function(t){console.log(e(t," at pages\\member\\map\\map.vue:773"))}})},queryMarkerInfo:function(){var t=this,a=[],o={id:1,name:t.activity_title,latitude:parseFloat(t.activity_lat),longitude:parseFloat(t.activity_lng),width:50,height:50,iconPath:"../../../images/ai_s.png",callout:{content:t.activity_title,color:"#2c8df6",fontSize:13,borderRadius:10,bgColor:"#fff",display:"ALWAYS",boxShadow:"5px 5px 10px #aaa"}};if(o&&a.push(o),t.longitude&&t.latitude){var n=wx.getStorageSync("userInfo")?wx.getStorageSync("userInfo"):"",i={id:2,name:"我的位置",latitude:t.latitude,longitude:t.longitude,width:35,height:35,iconPath:n.userAvatar?n.userAvatar:"../../../images/ai.png",callout:{content:"我",color:"#e34c55",fontSize:12,borderRadius:10,bgColor:"#fff",display:"ALWAYS",boxShadow:"5px 5px 10px #aaa"}};i&&a.push(i)}var s=[{points:[{latitude:parseFloat(t.activity_lat),longitude:parseFloat(t.activity_lng)},{latitude:t.latitude?t.latitude:parseFloat(t.activity_lat),longitude:t.longitude?t.longitude:parseFloat(t.activity_lng)}],color:"#ff6600",width:2,dottedLine:!1,arrowLine:!0,borderColor:"#000",borderWidth:2}];t.member_loc?t.setData({markers:a.concat(t.member_loc),markersMy:a}):t.setData({markers:a,markersMy:a}),t.setData({polyline:s}),console.log(e("queryMarkerInfo markers:",t.markers,"polyline:",s," at pages\\member\\map\\map.vue:870"))},createMarker:function(){var t=this,a=[],o=dataList.data;for(var n in o){var i=o[n];i.id=i.info_id,i.latitude=i.lat,i.longitude=i.lng,i.width=40,i.height=40,i.image?i.iconPath="../../../images/dog-select.png":i.iconPath="../../../images/dog-yellow.png"}a=a.concat(o),console.log(e(a," at pages\\member\\map\\map.vue:904")),t.setData({markers:a})},chooseAddress:function(){var e=this;wx.navigateTo({url:"../chooseAddress/chooseAddress?city="+e.centerAddressBean.address_component.city+"&street="+e.centerAddressBean.address_component.street})},checkUpdate:function(){if(wx.canIUse("getUpdateManager")){var t=wx.getUpdateManager();t.onCheckForUpdate(function(t){console.log(e("onCheckForUpdate-----------------\x3e"," at pages\\member\\map\\map.vue:928")),console.log(e(t.hasUpdate," at pages\\member\\map\\map.vue:929"))}),t.onUpdateReady(function(){wx.showModal({title:"更新提示",content:"新版本已经准备好，即刻体验？",success:function(e){e.confirm&&t.applyUpdate()}})}),t.onUpdateFailed(function(){})}},setData:function(e){var t,a,o=this,n=[];Object.keys(e).forEach(function(i){n=i.split("."),t=e[i],a=o.$data,n.forEach(function(e,i){i+1==n.length?o.$set(a,e,t):a[e]||o.$set(a,e,{}),a=a[e]})})}}};t.default=w}).call(this,a("0de9")["default"])},dfd9:function(e,t,a){"use strict";(function(e){a("ee7a"),a("921b");o(a("66fd"));var t=o(a("3853"));function o(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,a("6e42")["createPage"])}},[["dfd9","common/runtime","common/vendor"]]]);
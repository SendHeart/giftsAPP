(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/login/login"],{"0a36":function(e,n,t){"use strict";var a=function(){var e=this,n=e.$createElement;e._self._c},o=[];t.d(n,"a",function(){return a}),t.d(n,"b",function(){return o})},"7e69":function(e,n,t){"use strict";t.r(n);var a=t("8f74"),o=t.n(a);for(var r in a)"default"!==r&&function(e){t.d(n,e,function(){return a[e]})}(r);n["default"]=o.a},"8f74":function(e,n,t){"use strict";(function(e,a){Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var o=c(t("a34a")),r=c(t("80dc")),i=c(t("b934")),s=(c(t("a0f1")),c(t("aca9")),t("2f62"));function c(e){return e&&e.__esModule?e:{default:e}}function u(e,n,t,a,o,r,i){try{var s=e[r](i),c=s.value}catch(u){return void t(u)}s.done?n(c):Promise.resolve(c).then(a,o)}function l(e){return function(){var n=this,t=arguments;return new Promise(function(a,o){var r=e.apply(n,t);function i(e){u(r,a,o,i,s,"next",e)}function s(e){u(r,a,o,i,s,"throw",e)}i(void 0)})}}function d(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},a=Object.keys(t);"function"===typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.forEach(function(n){g(e,n,t[n])})}return e}function g(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var f=e.requireNativePlugin("longyoung-BDFaceAuth"),p=e.requireNativePlugin("longyoung-BDFaceAuth-iOS"),h=t("3936"),m=getApp().globalData.weburl,S=getApp().globalData.shop_type,v=e.getStorageSync("username"),y=getApp().globalData.md5_key,b=getApp().globalData.uploadurl,_=function(){return t.e("components/uni-icons/uni-icons").then(t.bind(null,"f9e2"))},w=function(){return t.e("components/uni-nav-bar/uni-nav-bar").then(t.bind(null,"daa9"))},I=function(){return t.e("components/m-input").then(t.bind(null,"60fa"))};v&&e.navigateBack();var x={components:{mInput:I,uniIcons:_,uniNavBar:w},data:function(){return{shop_type:S,uploadurl:b,username:v,providerList:[],hasProvider:!1,bypassword:!0,byface:!1,account:v,password:"",positionTop:0,vcode:"",title:"",faceimage:"",faceimage64:"",faceurl:"",licenseIDStr:"sendheartAppFace-face-ios",face_items:[{value:"Eye",name:"眨眨眼",checked:"true"},{value:"Mouth",name:"张张嘴",checked:"true"},{value:"HeadLeft",name:"向左转头",checked:"true"},{value:"HeadRight",name:"向右转头",checked:"true"},{value:"HeadLeftOrRight",name:"左右摇头",checked:"true"},{value:"HeadUp",name:"缓慢抬头",checked:"true"},{value:"HeadDown",name:"缓慢低头",checked:"true"}],isLivenessRandom:0,isSound:1,txtColor:"#3987FD",bgColor:"#2F2F33",roundColor:"#3987FD",resultStr:"",imgBase64Str:""}},computed:(0,s.mapState)(["forcedLogin"]),onLoad:function(){"ios"==e.getSystemInfoSync().platform?this.licenseIDStr="sendheartAppFace-face-ios":"android"==e.getSystemInfoSync().platform&&(this.licenseIDStr="sendheartAppFace-face-android"),this.facescan()},methods:d({},(0,s.mapMutations)(["login"]),{initProvider:function(){var n=this,t=["weixin","qq","sinaweibo"];e.getProvider({service:"oauth",success:function(e){if(e.provider&&e.provider.length){for(var a=0;a<e.provider.length;a++)~t.indexOf(e.provider[a])&&n.providerList.push({value:e.provider[a],image:"/static/"+e.provider[a]+".png"});n.hasProvider=!0}},fail:function(e){console.error(a("获取服务供应商失败："+JSON.stringify(e)," at pages\\login\\login.vue:181"))}})},initPosition:function(){this.positionTop=e.getSystemInfoSync().windowHeight-100},bindLogin:function(){var n=this.account?this.account:this.username;this.byface=!1,h.checkPhoneNumber(n)?this.password.length<6&&this.bypassword?e.showToast({icon:"none",title:"密码最短为 6 个字符"}):this.vcode||this.bypassword?this.my_login():e.showToast({icon:"none",title:"验证码不能为空"}):e.showToast({icon:"none",title:"手机号格式错误:"+n})},oauth:function(n){var t=this;e.login({provider:n,success:function(a){e.getUserInfo({provider:n,success:function(e){t.my_login()}})},fail:function(e){console.error(a("授权登录失败："+JSON.stringify(e)," at pages\\login\\login.vue:252"))}})},my_login:function(){var n=this,t=(e.getStorageSync("openid"),e.getStorageSync("username")?e.getStorageSync("username"):""),o=e.getStorageSync("user_phone")?e.getStorageSync("user_phone"):"",r=e.getStorageSync("user_name")?e.getStorageSync("user_name"):"",s=e.getStorageSync("userInfo"),c=n.nickname?n.nickname:s.nickname,u=n.avatarUrl?n.avatarUrl:s.avatarUrl,l=(e.getStorageSync("userauth"),n.faceurl,n.faceimage64),d=n.byface,g=n.bypassword,f=g?m+"/api/web/user/login/user_login":m+"/api/web/user/login/user_xcx_login";f=d?m+"/api/web/user/login/user_xcx_login":f;var p="";p=plus.push.getClientInfo();t=n.account?n.account:n.username;var h=n.vcode,v=n.password,b=(0,i.default)(n.password,y,!0),_=(g=n.bypassword,g?1:0);_=d?2:_,e.request({url:f,method:"POST",data:{username:t,password:v,md5password:b,wx_nickname:c,wx_headimg:u,user_phone:o,user_name:r,login_type:_,smscode:h,faceimage64:l,type:8,shop_type:S,clientinfo:JSON.stringify(p)},header:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},success:function(n){if("y"==n.data.status){e.showToast({icon:"none",title:d?"刷脸登录成功":"登录成功"});var t=n.data.result,o={nickname:t.wx_nickname,avatarUrl:t.wx_headimg},r=JSON.parse(n.data.result["userauth"]);console.log(a("app login 用户基本信息:",n.data.result," at pages\\login\\login.vue:318")),e.setStorageSync("clientinfo",p),e.setStorageSync("userInfo",o),e.setStorageSync("username",n.data.result["username"]),e.setStorageSync("m_id",n.data.result["m_id"]),e.setStorageSync("user_phone",n.data.result["user_phone"]),e.setStorageSync("user_name",n.data.result["user_name"]),e.setStorageSync("user_gender",n.data.result["user_gender"]),e.setStorageSync("user_type",n.data.result["user_type"]),e.setStorageSync("user_level",n.data.result["user_level"]),e.setStorageSync("userauth",r),e.reLaunch({url:"../hall/hall"})}else e.showToast({icon:"none",title:n.data.info?n.data.info:"用户账号或密码不正确"})}})},toMain:function(n){this.login(n),this.forcedLogin?e.reLaunch({url:"../main/main"}):e.navigateBack()},bypasswd:function(){var e=this;e.bypassword=!e.bypassword},byscanface:function(){var e=this;e.byface=!0,console.log(a("onScanFace starting..."," at pages\\login\\login.vue:358")),e.onScanFace(!0)},getcode:function(){var n=this,t=this.shop_type,o=this.account?this.account:this.username;console.log(a("get code phone no:",o," at pages\\login\\login.vue:372")),h.checkPhoneNumber(o)?wx.request({url:m+"/api/web/user/login/login_sms_send",method:"POST",data:{phoneNo:o,shop_type:t},header:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},success:function(t){console.log(a(t.data," at pages\\login\\login.vue:392")),"y"==t.data.status?(n.ret_info=t.data.data,e.showToast({icon:"none",title:"验证码已发送",duration:1500})):e.showToast({icon:"none",title:"验证码获取失败"+t.data.info,duration:2e3})}}):e.showToast({icon:"none",title:"手机号格式错误"+o})},onBackPress:function(n){return e.reLaunch({url:"../hall/hall"}),!0},onNavigationBarButtonTap:function(n){var t=this;0==n.index&&e.reLaunch({url:"../hall/hall"}),1==n.index&&(t.byface=!1,t.onScanFace(!1))},back:function(){e.reLaunch({url:"../hall/hall"})},facescan:function(){var e=l(o.default.mark(function e(){var n;return o.default.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.checkPermission();case 2:if(n=e.sent,1===n){e.next=5;break}return e.abrupt("return");case 5:case"end":return e.stop()}},e,this)}));function n(){return e.apply(this,arguments)}return n}(),checkPermission:function(){var n=l(o.default.mark(function n(t){var i,s,c,u;return o.default.wrap(function(n){while(1)switch(n.prev=n.next){case 0:if(console.log(a("checkPermission starting..."," at pages\\login\\login.vue:451")),!r.default.isIOS){n.next=7;break}return n.next=4,r.default.requestIOS("camera");case 4:n.t0=n.sent,n.next=10;break;case 7:return n.next=9,r.default.requestAndroid("android.permission.CAMERA");case 9:n.t0=n.sent;case 10:if(i=n.t0,null===i||1===i?i=1:e.showModal({content:"需要相机权限",confirmText:"设置",success:function(e){e.confirm&&r.default.gotoAppSetting()}}),!r.default.isIOS){n.next=16;break}n.t1=1,n.next=19;break;case 16:return n.next=18,r.default.requestAndroid("android.permission.WRITE_EXTERNAL_STORAGE");case 18:n.t1=n.sent;case 19:if(s=n.t1,null===s||1===s?s=1:e.showModal({content:"需要写数据权限",confirmText:"设置",success:function(e){e.confirm&&r.default.gotoAppSetting()}}),!r.default.isIOS){n.next=25;break}n.t2=1,n.next=28;break;case 25:return n.next=27,r.default.requestAndroid("android.permission.READ_EXTERNAL_STORAGE");case 27:n.t2=n.sent;case 28:return c=n.t2,null===c||1===c?c=1:e.showModal({content:"需要读数据权限",confirmText:"设置",success:function(e){e.confirm&&r.default.gotoAppSetting()}}),u=i&&s&&c?1:0,console.log(a("checkPermission ended...status:",u," at pages\\login\\login.vue:496")),n.abrupt("return",u);case 33:case"end":return n.stop()}},n,this)}));function t(e){return n.apply(this,arguments)}return t}(),onScanFace:function(n){console.log(a("onScanFace started..."," at pages\\login\\login.vue:502"));for(var t=this,o=n?0:1,r=[],i=0;i<t.face_items.length;i++){var s=t.face_items[i];s.checked&&(r[i]=s.value)}var c=n?"":r;console.log(a("onScanFace started..."," at pages\\login\\login.vue:515")),"android"==e.getSystemInfoSync().platform?(console.log(a("onScanFace android starting...",t.licenseIDStr," at pages\\login\\login.vue:517")),n?f.scanFace({licenseID:t.licenseIDStr?t.licenseIDStr:"sendheartAppFace-face-android",actionAry:[],isLivenessRandom:t.isLivenessRandom,isSound:1,txtColor:t.txtColor,bgColor:t.bgColor,roundColor:t.roundColor},function(e){console.log(a("file://"+e.imgPath," at pages\\login\\login.vue:528")),t.faceimage="file://"+e.imgPath,t.upload()}):f.scanFace({licenseID:t.licenseIDStr?t.licenseIDStr:"sendheartAppFace-face-android",actionAry:c,isLivenessRandom:o,isSound:1,txtColor:t.txtColor,bgColor:t.bgColor,roundColor:t.roundColor},function(e){console.log(a("file://"+e.imgPath," at pages\\login\\login.vue:542")),t.faceimage="file://"+e.imgPath,t.upload()})):"ios"==e.getSystemInfoSync().platform&&(n?(console.log(a("onScanFace ios byface starting...",t.licenseIDStr," at pages\\login\\login.vue:549")),p.scanFace({licenseID:t.licenseIDStr,actionAry:[],isLivenessRandom:t.isLivenessRandom,isSound:t.isSound,txtColor:t.txtColor,bgColor:t.bgColor,roundColor:t.roundColor},function(e){t.faceimage64=e.bestImgBase64.replace(/[\r\n]/g,""),t.upload()})):(console.log(a("onScanFace.ios onScanFace VIP starting...license ID:",t.licenseIDStr," at pages\\login\\login.vue:563")),p.scanFace({licenseID:"sendheartAppFace-face-ios",actionAry:c,isLivenessRandom:o,isSound:1,txtColor:t.txtColor,bgColor:t.bgColor,roundColor:t.roundColor},function(e){t.faceimage64=e.bestImgBase64.replace(/[\r\n]/g,""),t.upload()})))},upload:function(){var n=this,t=n.faceimage,a=e.getStorageSync("username")?e.getStorageSync("username"):"",o="face_"+a,r=n.byface?"face_login":"face_reg";if("face_login"==r){if("ios"!=e.getSystemInfoSync().platform){var i=new plus.nativeObj.Bitmap("sendheart_face_login");i.load(t,function(){var e=i.toBase64Data();n.faceimage64=e.replace(/[\r\n]/g,"")},function(n){e.showToast({title:"加载图片失败！"+JSON.stringify(n),duration:2e3})})}n.my_login()}else"ios"!=e.getSystemInfoSync().platform&&e.uploadFile({url:b,filePath:t,name:"wechat_upimg",formData:{latitude:encodeURI(0),longitude:encodeURI(0),type:encodeURI(r),city:encodeURI("杭州"),prov:encodeURI("浙江"),name:encodeURI(o)},success:function(t){var a=JSON.parse(t.data.trim());n.byface;"y"==a["status"]?n.faceurl=a["result"]["img_url"]:e.showToast({title:"系统错误！"+a["info"],duration:2e3})}}),n.update_userinfo()},update_userinfo:function(){var n=this,t=e.getStorageSync("username")?e.getStorageSync("username"):"",a=e.getStorageSync("token")?e.getStorageSync("token"):"1",o=n.faceurl?n.faceurl:"",r=n.shop_type,i=n.faceimage64;e.request({url:m+"/api/client/update_name",method:"POST",data:{username:t,access_token:a,type:2,shop_type:r,faceurl:o,faceimage64:i},header:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},success:function(n){"y"==n.data.status?(e.showToast({title:"VIP认证成功！",duration:2e3}),e.setStorageSync("user_level",n.data.result["user_level"])):e.showToast({title:n.data.info?n.data.info:"VIP认证失败！",duration:2e3})}})}}),onReady:function(){this.initPosition(),this.initProvider(),this.username=e.getStorageSync("username")?e.getStorageSync("username"):""}};n.default=x}).call(this,t("6e42")["default"],t("0de9")["default"])},"8f7b":function(e,n,t){"use strict";t.r(n);var a=t("0a36"),o=t("7e69");for(var r in o)"default"!==r&&function(e){t.d(n,e,function(){return o[e]})}(r);t("ca27");var i=t("2877"),s=Object(i["a"])(o["default"],a["a"],a["b"],!1,null,null,null);n["default"]=s.exports},9789:function(e,n,t){},c787:function(e,n,t){"use strict";(function(e){t("ee7a"),t("921b");a(t("66fd"));var n=a(t("8f7b"));function a(e){return e&&e.__esModule?e:{default:e}}e(n.default)}).call(this,t("6e42")["createPage"])},ca27:function(e,n,t){"use strict";var a=t("9789"),o=t.n(a);o.a}},[["c787","common/runtime","common/vendor"]]]);